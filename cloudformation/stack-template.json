{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Transform": "AWS::Serverless-2016-10-31",
  "Parameters": {
    "ProjectName": {
      "Type": "String"
    },
    "ServiceName": {
      "Type": "String"
    },
    "BranchName": {
      "Type": "String"
    },
    "JWTSecret": {
      "Type": "String",
      "NoEcho": true
    },
    "GithubClientId": {
      "Type": "String",
      "NoEcho": true
    },
    "GithubClientSecret": {
      "Type": "String",
      "NoEcho": true
    },
    "StripeSecretKey": {
      "Type": "String",
      "NoEcho": true
    },
    "StripeApiUrl": {
      "Type": "String"
    }
  },
  "Resources": {
    "GitcheeseApiBucket": {
      "Type": "AWS::S3::Bucket",
      "Properties": {
        "BucketName": { "Fn::Sub": "${ProjectName}-${ServiceName}-${BranchName}" }
      }
    },
    "GitcheeseRestApi": {
      "Type": "AWS::Serverless::Api",
      "Properties": {
        "StageName": "v1",
        "DefinitionUri": "./api-swagger.json",
        "Variables": {
          "TokensGithubGetFunctionName": { "Ref": "TokensGithubGetFunction" },
          "TokensGithubCallbackGetFunctionName": { "Ref": "TokensGithubCallbackGetFunction" },
          "UserGetFunctionName": { "Ref": "UserGetFunction" },
          "UserPutFunctionName": { "Ref": "UserPutFunction" },
          "UserReposPutFunctionName": { "Ref": "UserReposPutFunction" },
          "UserReposGetFunctionName": { "Ref": "UserReposGetFunction" },
          "UserReposIdGetFunctionName": { "Ref": "UserReposIdGetFunction" },
          "UserManagedAccountsGetFunctionName": { "Ref": "UserManagedAccountsGetFunction" },
          "UserManagedAccountsPostFunctionName": { "Ref": "UserManagedAccountsPostFunction" },
          "BucketName": { "Ref": "GitcheeseApiBucket" },
          "JWTSecret": { "Fn::Sub": "${JWTSecret}" },
          "GithubClientId": { "Fn::Sub": "${GithubClientId}" },
          "GithubClientSecret": { "Fn::Sub": "${GithubClientSecret}" },
          "StripeSecretKey": { "Fn::Sub": "${StripeSecretKey}" },
          "StripeApiUrl": { "Fn::Sub": "${StripeApiUrl}" },
          "RedirectUrl": "https://gitcheese.com/login/github/token"
        }
      }
    },
    "AuthorizerFunction": {
      "Type": "AWS::Serverless::Function",
      "Properties": {
        "FunctionName": { "Fn::Sub": "${ProjectName}-${ServiceName}-${BranchName}-AuthorizerFunction" },
        "Handler": "index.handler",
        "Runtime": "nodejs4.3",
        "Policies": ["AWSLambdaBasicExecutionRole", "AmazonS3FullAccess"],
        "CodeUri": "./../api/authorizer",
        "Environment": {
          "Variables": {
            "JWT_SECRET": { "Fn::Sub": "${JWTSecret}" }
          }
        }
      }
    },
    "TokensGithubGetFunction": {
      "Type": "AWS::Serverless::Function",
      "Properties": {
        "Handler": "index.get",
        "Runtime": "nodejs4.3",
        "Policies": ["AWSLambdaBasicExecutionRole", "AmazonS3FullAccess"],
        "CodeUri": "./../api/tokens/github/get",
        "Timeout": 10,
        "Events": {
          "GetResource": {
            "Type": "Api",
            "Properties": {
              "Path": "/tokens/github",
              "Method": "GET",
              "RestApiId": { "Ref": "GitcheeseRestApi" }
            }
          }
        }
      }
    },
    "TokensGithubCallbackGetFunction": {
      "Type": "AWS::Serverless::Function",
      "Properties": {
        "Handler": "index.get",
        "Runtime": "nodejs4.3",
        "Policies": ["AWSLambdaBasicExecutionRole", "AmazonS3FullAccess"],
        "CodeUri": "./../api/tokens/github/callback/get",
        "Timeout": 10,
        "Events": {
          "GetResource": {
            "Type": "Api",
            "Properties": {
              "Path": "/tokens/github/callback",
              "Method": "GET",
              "RestApiId": { "Ref": "GitcheeseRestApi" }
            }
          }
        }
      }
    },
    "UserGetFunction": {
      "Type": "AWS::Serverless::Function",
      "Properties": {
        "Handler": "index.get",
        "Runtime": "nodejs4.3",
        "Policies": ["AWSLambdaBasicExecutionRole", "AmazonS3FullAccess"],
        "CodeUri": "./../api/user/get",
        "Timeout": 10,
        "Events": {
          "GetResource": {
            "Type": "Api",
            "Properties": {
              "Path": "/user",
              "Method": "GET",
              "RestApiId": { "Ref": "GitcheeseRestApi" }
            }
          }
        }
      }
    },
    "UserPutFunction": {
      "Type": "AWS::Serverless::Function",
      "Properties": {
        "Handler": "index.put",
        "Runtime": "nodejs4.3",
        "Policies": ["AWSLambdaBasicExecutionRole", "AmazonS3FullAccess"],
        "CodeUri": "./../api/user/put",
        "Timeout": 10,
        "Events": {
          "GetResource": {
            "Type": "Api",
            "Properties": {
              "Path": "/user",
              "Method": "PUT",
              "RestApiId": { "Ref": "GitcheeseRestApi" }
            }
          }
        }
      }
    },
    "UserReposPutFunction": {
      "Type": "AWS::Serverless::Function",
      "Properties": {
        "Handler": "index.put",
        "Runtime": "nodejs4.3",
        "Policies": ["AWSLambdaBasicExecutionRole", "AmazonS3FullAccess"],
        "CodeUri": "./../api/user/repos/put",
        "Timeout": 10,
        "Events": {
          "GetResource": {
            "Type": "Api",
            "Properties": {
              "Path": "/user/repos",
              "Method": "PUT",
              "RestApiId": { "Ref": "GitcheeseRestApi" }
            }
          }
        }
      }
    },
    "UserReposGetFunction": {
      "Type": "AWS::Serverless::Function",
      "Properties": {
        "Handler": "index.get",
        "Runtime": "nodejs4.3",
        "Policies": ["AWSLambdaBasicExecutionRole", "AmazonS3FullAccess"],
        "CodeUri": "./../api/user/repos/get",
        "Timeout": 10,
        "Events": {
          "GetResource": {
            "Type": "Api",
            "Properties": {
              "Path": "/user/repos",
              "Method": "GET",
              "RestApiId": { "Ref": "GitcheeseRestApi" }
            }
          }
        }
      }
    },
    "UserReposIdGetFunction": {
      "Type": "AWS::Serverless::Function",
      "Properties": {
        "Handler": "index.get",
        "Runtime": "nodejs4.3",
        "Policies": ["AWSLambdaBasicExecutionRole", "AmazonS3FullAccess"],
        "CodeUri": "./../api/user/repos/id/get",
        "Timeout": 10,
        "Events": {
          "GetResource": {
            "Type": "Api",
            "Properties": {
              "Path": "/user/repos/{id}",
              "Method": "GET",
              "RestApiId": { "Ref": "GitcheeseRestApi" }
            }
          }
        }
      }
    },
    "UserManagedAccountsPostFunction": {
      "Type": "AWS::Serverless::Function",
      "Properties": {
        "Handler": "index.post",
        "Runtime": "nodejs4.3",
        "Policies": ["AWSLambdaBasicExecutionRole", "AmazonS3FullAccess"],
        "CodeUri": "./../api/user/managed-accounts/post",
        "Timeout": 10,
        "Events": {
          "GetResource": {
            "Type": "Api",
            "Properties": {
              "Path": "/user/managed-accounts",
              "Method": "POST",
              "RestApiId": { "Ref": "GitcheeseRestApi" }
            }
          }
        }
      }
    },
    "UserManagedAccountsGetFunction": {
      "Type": "AWS::Serverless::Function",
      "Properties": {
        "Handler": "index.get",
        "Runtime": "nodejs4.3",
        "Policies": ["AWSLambdaBasicExecutionRole", "AmazonS3FullAccess"],
        "CodeUri": "./../api/user/managed-accounts/get",
        "Timeout": 10,
        "Events": {
          "GetResource": {
            "Type": "Api",
            "Properties": {
              "Path": "/user/managed-accounts",
              "Method": "GET",
              "RestApiId": { "Ref": "GitcheeseRestApi" }
            }
          }
        }
      }
    }
  }
}
