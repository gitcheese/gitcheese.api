{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Transform": "AWS::Serverless-2016-10-31",
  "Parameters": {
    "ProjectName": {
      "Type": "String"
    },
    "ServiceName": {
      "Type": "String"
    },
    "BranchName": {
      "Type": "String"
    },
    "JWTSecret": {
      "Type": "String",
      "NoEcho": true
    },
    "GithubClientId": {
      "Type": "String",
      "NoEcho": true
    },
    "GithubClientSecret": {
      "Type": "String",
      "NoEcho": true
    }
  },
  "Resources": {
    "GitcheeseApiBucket": {
      "Type": "AWS::S3::Bucket",
      "Properties": {
        "BucketName": { "Fn::Sub": "${ProjectName}-${ServiceName}-${BranchName}" }
      }
    },
    "GitcheeseRestApi": {
      "Type": "AWS::Serverless::Api",
      "Properties": {
        "StageName": "v1",
        "DefinitionUri": "./api-swagger.json",
        "Variables": {
          "TokensGithubGetFunctionName": { "Ref": "TokensGithubGetFunction" },
          "TokensGithubCallbackGetFunctionName": { "Ref": "TokensGithubCallbackGetFunction" },
          "ProfilesGetFunctionName": { "Ref": "ProfilesGetFunction" },
          "ProfilesPutFunctionName": { "Ref": "ProfilesPutFunction" },
          "ProjectsPutFunctionName": { "Ref": "ProjectsPutFunction" },
          "ProjectsGetFunctionName": { "Ref": "ProjectsGetFunction" },
          "ProjectsIdGetFunctionName": { "Ref": "ProjectsIdGetFunction" },
          "BucketName": { "Ref": "GitcheeseApiBucket" },
          "JWTSecret": { "Fn::Sub": "${JWTSecret}" },
          "GithubClientId": { "Fn::Sub": "${GithubClientId}" },
          "GithubClientSecret": { "Fn::Sub": "${GithubClientSecret}" },
          "RedirectUrl": "https://gitcheese.com/login/github/token"
        }
      }
    },
    "AuthorizerFunction": {
      "Type": "AWS::Serverless::Function",
      "Properties": {
        "FunctionName": { "Fn::Sub": "${ProjectName}-${ServiceName}-${BranchName}-AuthorizerFunction" },
        "Handler": "index.handler",
        "Runtime": "nodejs4.3",
        "Policies": ["AWSLambdaBasicExecutionRole", "AmazonS3FullAccess"],
        "CodeUri": "./../api/authorizer",
        "Environment": {
          "Variables": {
            "JWT_SECRET": { "Fn::Sub": "${JWTSecret}" }
          }
        }
      }
    },
    "TokensGithubGetFunction": {
      "Type": "AWS::Serverless::Function",
      "Properties": {
        "Handler": "index.get",
        "Runtime": "nodejs4.3",
        "Policies": ["AWSLambdaBasicExecutionRole", "AmazonS3FullAccess"],
        "CodeUri": "./../api/tokens/github/get",
        "Timeout": 10,
        "Events": {
          "GetResource": {
            "Type": "Api",
            "Properties": {
              "Path": "/tokens/github",
              "Method": "GET",
              "RestApiId": { "Ref": "GitcheeseRestApi" }
            }
          }
        }
      }
    },
    "TokensGithubCallbackGetFunction": {
      "Type": "AWS::Serverless::Function",
      "Properties": {
        "Handler": "index.get",
        "Runtime": "nodejs4.3",
        "Policies": ["AWSLambdaBasicExecutionRole", "AmazonS3FullAccess"],
        "CodeUri": "./../api/tokens/github/callback/get",
        "Timeout": 10,
        "Events": {
          "GetResource": {
            "Type": "Api",
            "Properties": {
              "Path": "/tokens/github/callback",
              "Method": "GET",
              "RestApiId": { "Ref": "GitcheeseRestApi" }
            }
          }
        }
      }
    },
    "ProfilesGetFunction": {
      "Type": "AWS::Serverless::Function",
      "Properties": {
        "Handler": "index.get",
        "Runtime": "nodejs4.3",
        "Policies": ["AWSLambdaBasicExecutionRole", "AmazonS3FullAccess"],
        "CodeUri": "./../api/profiles/get",
        "Timeout": 10,
        "Events": {
          "GetResource": {
            "Type": "Api",
            "Properties": {
              "Path": "/profiles",
              "Method": "GET",
              "RestApiId": { "Ref": "GitcheeseRestApi" }
            }
          }
        }
      }
    },
    "ProfilesPutFunction": {
      "Type": "AWS::Serverless::Function",
      "Properties": {
        "Handler": "index.put",
        "Runtime": "nodejs4.3",
        "Policies": ["AWSLambdaBasicExecutionRole", "AmazonS3FullAccess"],
        "CodeUri": "./../api/profiles/put",
        "Timeout": 10,
        "Events": {
          "GetResource": {
            "Type": "Api",
            "Properties": {
              "Path": "/profiles",
              "Method": "PUT",
              "RestApiId": { "Ref": "GitcheeseRestApi" }
            }
          }
        }
      }
    },
    "ProjectsPutFunction": {
      "Type": "AWS::Serverless::Function",
      "Properties": {
        "Handler": "index.put",
        "Runtime": "nodejs4.3",
        "Policies": ["AWSLambdaBasicExecutionRole", "AmazonS3FullAccess"],
        "CodeUri": "./../api/projects/put",
        "Timeout": 10,
        "Events": {
          "GetResource": {
            "Type": "Api",
            "Properties": {
              "Path": "/projects",
              "Method": "PUT",
              "RestApiId": { "Ref": "GitcheeseRestApi" }
            }
          }
        }
      }
    },
    "ProjectsGetFunction": {
      "Type": "AWS::Serverless::Function",
      "Properties": {
        "Handler": "index.get",
        "Runtime": "nodejs4.3",
        "Policies": ["AWSLambdaBasicExecutionRole", "AmazonS3FullAccess"],
        "CodeUri": "./../api/projects/get",
        "Timeout": 10,
        "Events": {
          "GetResource": {
            "Type": "Api",
            "Properties": {
              "Path": "/projects",
              "Method": "GET",
              "RestApiId": { "Ref": "GitcheeseRestApi" }
            }
          }
        }
      }
    },
    "ProjectsIdGetFunction": {
      "Type": "AWS::Serverless::Function",
      "Properties": {
        "Handler": "index.get",
        "Runtime": "nodejs4.3",
        "Policies": ["AWSLambdaBasicExecutionRole", "AmazonS3FullAccess"],
        "CodeUri": "./../api/projects/id/get",
        "Timeout": 10,
        "Events": {
          "GetResource": {
            "Type": "Api",
            "Properties": {
              "Path": "/projects/{id}",
              "Method": "GET",
              "RestApiId": { "Ref": "GitcheeseRestApi" }
            }
          }
        }
      }
    }
  }
}
